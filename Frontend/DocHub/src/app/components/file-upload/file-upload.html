<!-- Drag Overlay -->
@if (isDragging && mode !== 'edit') {
  <div
    class="fixed inset-0 z-[60] bg-blue-600/30 backdrop-blur-sm flex items-center justify-center pointer-events-none"
  >
    <div
      class="bg-white rounded-2xl border-2 border-dashed border-blue-500 px-10 py-8 text-center shadow-2xl"
    >
      <div class="text-5xl mb-3">ðŸ“‚</div>
      <h3 class="text-lg font-semibold text-blue-700">Drop file to upload</h3>
      <p class="text-sm text-blue-500 mt-1">Release your mouse to continue</p>
    </div>
  </div>
}

<!-- Floating Add Button -->
@if (mode !== 'edit') {
  <button
    (click)="open()"
    class="flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold shadow-sm hover:bg-blue-700 active:scale-95 transition"
  >
    <span class="text-lg leading-none">+</span>
    Add
  </button>
}

<!-- Overlay -->
@if (isOpen) {
  <div class="fixed inset-0 z-50 bg-blue-900/30 backdrop-blur-sm flex justify-center items-center">
    <!-- MODAL -->
    <div
      class="relative bg-white w-full h-full sm:w-[820px] sm:h-[540px] rounded-none sm:rounded-2xl shadow-2xl flex flex-col sm:flex-row overflow-hidden"
    >
      <!-- CLOSE BUTTON (ALWAYS VISIBLE) -->
      <button
        (click)="deletefiles()"
        class="absolute top-3 right-3 z-50 w-9 h-9 rounded-full bg-white text-gray-600 border shadow hover:bg-red-50 hover:text-red-600 active:scale-95 transition"
      >
        âœ•
      </button>

      <!-- LEFT TABS -->
      <div
        class="sm:w-56 w-full bg-blue-50 border-b sm:border-b-0 sm:border-r p-3 space-y-2 overflow-x-auto sm:overflow-y-auto flex sm:flex-col gap-2"
      >
        <label class="text-sm font-semibold text-blue-700"> Upload Files </label>

        @if (mode !== 'edit') {
          <label
            class="border-2 border-dashed border-blue-300 rounded-xl px-4 py-2 text-center cursor-pointer hover:bg-blue-100 transition"
          >
            <span class="text-blue-600 text-sm">âž• Add Files</span>
            <input type="file" multiple hidden (change)="onFilesSelected($event)" />
          </label>
        }

        @for (file of uploads; track file.id; let i = $index) {
          <!-- REMOVE -->
          <div
            (click)="activeIndex = i"
            class="relative p-3 rounded-xl cursor-pointer border transition"
            [class.bg-blue-100]="i === activeIndex"
            [class.bg-green-100]="file.progress === 100"
            [class.bg-red-100]="file.stage === 'failed'"
          >
            <div class="text-sm font-medium truncate">{{ file.name }}</div>

            <div class="h-1 mt-2 bg-gray-200 rounded">
              <div
                class="h-full bg-blue-500 rounded transition-all"
                [style.width.%]="file.progress"
              ></div>
            </div>

            <button
              class="absolute top-1 right-2 text-xs text-red-500"
              (click)="removeUpload(i); $event.stopPropagation()"
            >
              âœ•
            </button>
          </div>
        }
      </div>

      <!-- RIGHT PANEL -->
      @if (active) {
        <div class="flex-1 p-4 sm:p-5 space-y-4 overflow-y-auto">
          <!-- PROGRESS WITH STAGES -->
          <div class="flex items-center gap-2 mt-2">
            <!-- Progress bar -->
            <div class="relative flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-700 ease-out"
                [ngClass]="{
                  'bg-gray-400': active.stage === 'initiated',
                  'bg-blue-500': active.stage === 'queued',
                  'bg-indigo-500': active.stage === 'uploaded',
                  'bg-purple-500': active.stage === 'tagging',
                  'bg-green-600': active.stage === 'ready',
                  'bg-red-500': active.stage === 'failed',
                }"
                [style.width.%]="active.stage === 'failed' ? 100 : stageProgress(active.stage)"
              ></div>
            </div>

            <!-- Retry button (ONLY on failure) -->
            @if (active.stage === 'failed') {
              <button
                class="shrink-0 text-xs px-2 py-1 rounded-md bg-yellow-500 text-white hover:bg-yellow-600 transition"
                (click)="retryFile(active); $event.stopPropagation()"
              >
              @if(active.isRetrying==true){
                <app-spinner [size]="'sm'"></app-spinner>
              }@else{
                Retry
              }
              </button>
            }
          </div>

          <!-- PREVIEW -->
          @if (active.preview_url !=null) {
            <img
              *ngIf="active.preview_url"
              [src]="active.preview_url"
              class="h-40 w-full object-contain border rounded-xl bg-blue-50"
            />
          } @else {
            <div
              class="h-40 w-full object-contain flex justify-center items-center border rounded-xl bg-blue-50"
            >
              <i
                [class]="
                  FILE_TYPE_ICON[active.type] + ' ' + FILE_TYPE_COLOR[active.type] + ' text-4xl'
                "
              ></i>
            </div>
          }

          <!-- TITLE -->
          <input
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400"
            [(ngModel)]="active.name"
            placeholder="Title"
          />

          <!-- DESCRIPTION -->
          <textarea
            rows="2"
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400"
            [(ngModel)]="active.description"
            placeholder="Description"
          ></textarea>

          <!-- TAGS -->
          <div class="border-2 border-blue-200 rounded-xl p-4 bg-blue-50">
            <div class="flex gap-2 flex-wrap mb-2">
              @for (tag of active.tags; track tag) {
                <span
                  class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm flex gap-2 items-center"
                >
                  {{ tag }}
                  <button (click)="removeTag(tag)">âœ•</button>
                </span>
              }
            </div>

            <div class="flex gap-2">
              <input
                class="flex-1 border rounded-lg px-3 py-2"
                placeholder="Add tag"
                [(ngModel)]="tagInput"
                (keyup.enter)="addTag()"
              />
              <button class="bg-blue-600 text-white px-4 rounded-lg" (click)="addTag()">Add</button>
            </div>
          </div>

          <!-- ACTIONS -->
          <div class="flex gap-3 pt-2">
            <button
              class="flex-1 py-2 bg-blue-600 text-white rounded-lg disabled:bg-blue-300"
              [disabled]="!canUploadAll()"
              (click)="uploadAll()"
            >
              Upload All
            </button>

            <button class="px-4 py-2 text-red-500 border rounded-lg" (click)="deletefiles()">
              Cancel
            </button>
          </div>
        </div>
      }
    </div>
  </div>
}
